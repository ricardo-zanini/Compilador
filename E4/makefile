# ============ GRUPO R ==================
# Bernardo Cobalchini Zietolie - 00550164
# Ricardo Zanini de Costa - 00344523

# ============ VARI√ÅVEIS ===========

BISON = bison
FLEX = flex
CC = gcc
# Adicionamos -MMD -MP para gerar depend√™ncias (.d) automaticamente
CFLAGS = -Wall -Werror -fsanitize=address -MMD -MP

# --- Arquivos de C√≥digo Gerados ---
BISON_FILE = parser.y
FLEX_FILE = scanner.l
BISON_OUTPUT = parser.tab.c
BISON_HEADER = parser.tab.h
FLEX_OUTPUT = lex.yy.c

# --- Arquivos de C√≥digo Manuais ---
ASD_SOURCE = asd.c
TABELA_SOURCE = tabelaSimbolos.c
ERROS_SOURCE = erros.c
SEMANTICA_SOURCE = semantica.c
MAIN_SOURCE = main.c

# --- Cabe√ßalhos ---
ASD_HEADER = asd.h
TABELA_HEADER = tabelaSimbolos.h
ERROS_HEADER = erros.h
SEMANTICA_HEADER = semantica.h
HEADERS = uthash.h tipos.h

# --- Agrupamento de Objetos ---
MANUAL_OBJECTS = $(ASD_SOURCE:.c=.o) $(TABELA_SOURCE:.c=.o) $(ERROS_SOURCE:.c=.o) $(SEMANTICA_SOURCE:.c=.o)
GENERATED_OBJECTS = $(BISON_FILE:.y=.tab.o) $(FLEX_OUTPUT:.c=.o)
OBJECTS = $(GENERATED_OBJECTS) $(MANUAL_OBJECTS) $(MAIN_SOURCE:.c=.o)

# --- Arquivos de Depend√™ncia (.d) ---
DEPS = $(OBJECTS:.o=.d)

# --- Execut√°vel ---
EXEC = etapa4
SELF = makefile

# Alvos que n√£o s√£o arquivos
.PHONY: all clean tgz

# Alvo Padr√£o
all: $(EXEC)
	@echo "Compila√ß√£o conclu√≠da ‚úÖ"

# ============== BISON ==============
# Regra para gerar parser.tab.c e parser.tab.h
$(BISON_OUTPUT) $(BISON_HEADER): $(BISON_FILE)
	@$(BISON) -d $(BISON_FILE)

# =============== FLEX ==============
# Regra para gerar lex.yy.c (depende do header do Bison)
$(FLEX_OUTPUT): $(FLEX_FILE) $(BISON_HEADER)
	@$(FLEX) $(FLEX_FILE)

# ============ COMPILA√á√ÉO ============

$(GENERATED_OBJECTS): $(BISON_HEADER)

# REGRA UNIVERSAL DE COMPILA√á√ÉO
%.o: %.c
	@$(CC) $(CFLAGS) -c $< -o $@

# --- Regra de Linkagem Final ---
$(EXEC): $(OBJECTS)
	@$(CC) $(CFLAGS) -o $@ $(OBJECTS)

# ============== CLEAN ==============
clean:
	@rm -f $(EXEC) $(BISON_OUTPUT) $(BISON_HEADER) $(FLEX_OUTPUT) $(OBJECTS) $(DEPS)
	@echo "Limpeza conclu√≠da üóëÔ∏è"

# ============== COMPACTAR ==============
tgz: clean
	@tar -czvf $(EXEC).tgz $(SEMANTICA_SOURCE) $(SEMANTICA_HEADER) $(ERROS_SOURCE) $(ERROS_HEADER) $(TABELA_SOURCE) $(TABELA_HEADER) $(ASD_SOURCE) $(ASD_HEADER) $(HEADERS) $(MAIN_SOURCE) $(SELF) $(BISON_FILE) $(FLEX_FILE)
	@echo "Compacta√ß√£o conclu√≠da üì¶"

# Inclui os arquivos de depend√™ncia .d gerados
-include $(DEPS)

# --> "It makes your life easier" <--